#! /bin/sh
release=yes
if test x"$1" = x-t ; then
   release=
fi
if test x"$release" = xyes ; then
   if ! cvs diff > /dev/null 2> /dev/null ; then
      echo There are changes not checked into CVS - please rectify
      exit 1
   fi
   # Update ChangeLog
   CVS2CL=./cvs2cl.pl
   if ! test -x $CVS2CL ; then
      CVS2CL=../cvs2cl/cvs2cl.pl
   fi
   if ! $CVS2CL 2> /dev/null ; then
      echo Failed to update ChangeLog from CVS
      exit 1
   fi
fi
if test -f Makefile ; then
   if ! make distclean ; then
      echo make distclean failed
      exit 1
   fi
fi
aclocal
autoheader
automake -a
autoconf
if ! ./configure ; then
   echo configure failed
   exit 1
fi
# make distcheck fails - cvs version of automake doesn't clean up all the
# files it creates...
if ! make dist ; then
   echo make dist failed
   exit 1
fi
if test x"$release" = xyes ; then
   if rpm --version > /dev/null 2> /dev/null ; then
      if ! make rpm ; then
         echo make rpm failed
         exit 1
       fi
   else
       echo rpm not installed - skipping rpm generation
   fi
   if ! make debian ; then
      echo make debian failed
      exit 1
   fi
   if ! make dos_doc_zip ; then
      echo make dos_doc_zip failed
      exit 1
   fi
fi
if ! make alien_src_zip ; then
   echo make alien_src_zip failed
   exit 1
fi
if ! make distclean ; then
   echo make distclean failed
   exit 1
fi
(
# for building on mrs30
if test -d /opt/crosstools/i386-pc-msdosdjgpp ; then
   PATH=/opt/crosstools/i386-pc-msdosdjgpp/bin:/opt/crosstools/bin:$PATH
fi
if ! env LDFLAGS=-s STRIP=echo CAVEROT=caverot.exe \
 CRLIB=-lalleg CROBJX=dosrot.o ./configure --with-x=no ; then
   echo djgpp configure failed
   exit 1
fi
if ! make ; then
   echo djgpp make failed
   exit 1
fi
#if test x"$release" = xyes ; then
   if ! make djgpp_zip ; then
      echo djgpp make djgpp_zip failed
      exit 1
   fi
#fi
if ! make distclean ; then
   echo make distclean failed
   exit 1
fi
)
(
if test -d /usr/local/cross-tools/i386-mingw32msvc/bin ; then
   # binaries from http://www.devolution.com/~slouken/SDL/Xmingw32/
   PATH=/usr/local/cross-tools/bin:/usr/local/cross-tools/i386-mingw32msvc/bin:$PATH
else
   # debian mingw32 package
   PATH=/usr/i386-mingw32msvc/bin:$PATH
   CC=/usr/bin/i386-mingw32msvc-gcc
   export CC
   CXX=/usr/bin/i386-mingw32msvc-g++
   export CXX
fi
if ! env LDFLAGS=-s CAVEROT= ./configure --with-x=no ; then
   echo mingw configure failed
   exit 1
fi
if ! make ; then
   echo mingw make failed
   exit 1
fi
#if test x"$release" = xyes ; then
   if ! make mingw_zip ; then
      echo mingw make mingw_zip failed
      exit 1
   fi
#fi
if ! make distclean ; then
   echo make distclean failed
   exit 1
fi
)
