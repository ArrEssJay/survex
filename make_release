#! /bin/sh
release=yes
if test x"$1" = x-t ; then
   release=
fi
if test x"$release" = xyes ; then
   if ! cvs diff > /dev/null 2> /dev/null ; then
      echo There are changes not checked into CVS - please rectify
      exit 1
   fi
   # Update ChangeLog
   if ! ../cvs2cl/cvs2cl.pl 2> /dev/null ; then
      echo Failed to update ChangeLog from CVS
      exit 1
   fi
fi
if test -f Makefile ; then
   if ! make distclean ; then
      echo make distclean failed
      exit 1
   fi
fi
if ! ./configure ; then
   echo configure failed
   exit 1
fi
# make distcheck fails - cvs version of automake doesn't clean up all the
# files it creates...
if ! make dist ; then
   echo make dist failed
   exit 1
fi
if test x"$release" = xyes ; then
   if ! make rpm ; then
      echo make rpm failed
      exit 1
   fi
   if ! make debian ; then
      echo make rpm failed
      exit 1
   fi
   if ! make dos_doc_zip ; then
      echo make dos_doc_zip failed
      exit 1
   fi
fi
if ! make alien_src_zip ; then
   echo make alien_src_zip failed
   exit 1
fi
if ! make distclean ; then
   echo make distclean failed
   exit 1
fi
if ! env CC=i386-pc-msdosdjgpp-gcc LDFLAGS=-s STRIP=echo CAVEROT=caverot.exe \
 CRLIB=-lalleg CROBJX=dosrot.o ./configure --with-x=no ; then
   echo djgpp configure failed
   exit 1
fi
if ! make ; then
   echo djgpp make failed
   exit 1
fi
#if test x"$release" = xyes ; then
   if ! make djgpp_zip ; then
      echo djgpp make djgpp_zip failed
      exit 1
   fi
#fi
if ! make distclean ; then
   echo make distclean failed
   exit 1
fi
PATH=/usr/local/cross-tools/bin:/usr/local/cross-tools/i386-mingw32msvc/bin:$PATH
if ! env ac_cv_c_bigendian=no LDFLAGS=-s CAVEROT= ./configure --with-x=no ; then
   echo mingw configure failed
   exit 1
fi
if ! make ; then
   echo mingw make failed
   exit 1
fi
#if test x"$release" = xyes ; then
   if ! make mingw_zip ; then
      echo mingw make mingw_zip failed
      exit 1
   fi
#fi
if ! make distclean ; then
   echo make distclean failed
   exit 1
fi
